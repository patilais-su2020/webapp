version: 2.1
orbs:
  node: circleci/node@1.1.6
jobs:
  build:
    executor:
      name: node/default
      
    steps:
      - checkout
      - run:
          name: Install packages
          command: |
            node --version
            sudo apt install wget zip unzip curl -y
      - node/with-cache:
          steps:
            - run:
                name: Build artifacts
                command:  |
                  cd backend && npm install
                  cd frontend && npm install
            - run:
                name: clean node_modules
                command: |
                  sudo rm -rf node_modules
                  cd frontend
                  sudo rm -rf node_modules 
      - run:
          name: Compress Artifacts
          command: |
            echo "Current directory: "`pwd`
            echo "Files in directory:"`ls`
            zip -r csye6225-webapp-${CIRCLE_BUILD_NUM}.zip .
      - run:
          name: Upload Artifacts to S3
          command: |
            ls -la
            aws configure list
            aws s3 cp csye6225-webapp-${CIRCLE_BUILD_NUM}.zip s3://codedeploy.neucloudwebapp.me --sse
      - run:
          name: Call CodeDeploy API
          command: |
            aws deploy create-deployment --output json --application-name csye6225-webapp --deployment-config-name CodeDeployDefault.AllAtOnce --deployment-group-name csye6225-webapp-deployment --s3-location bucket=codedeploy.neucloudwebapp.me, bundleType=zip,key=csye6225-webapp-${CIRCLE_BUILD_NUM}.zip
  test:
    executor:
      name: node/default
    steps:
      - checkout
      - run: cd backend
      - node/with-cache:
          steps:
            - run: cd backend && npm install
            - run: cd backend && npm test
workflows:
    pr_check:
      jobs:
        - build
        - test
